<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
  <link rel="profile" href="http://www.w3.org/1999/xhtml/vocab" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script 
      src="https://code.jquery.com/jquery-3.6.0.min.js" 
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
      crossorigin="anonymous">
    </script>
  <link 
      rel="stylesheet" 
      href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
  <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" 
      integrity="sha512-5A8nwdMOWrSz20fDsjczgUidUBR8liPYU+WymTZP1lmY9G6Oc7HlZv156XqnsgNUzTyMefFTcsFH/tnJE/+xBg=="
      crossorigin="anonymous" 
      referrerpolicy="no-referrer" />  
  <link 
      rel="stylesheet" 
      href="https://capacita-back.argentina.gob.ar/profiles/argentinagobar/themes/contrib/poncho/css/icono-arg.css">
  <!-- Dev files -->
  <link rel="stylesheet" href="../../../dist/css/poncho.min.css" />
  <title>Mapa Puntos Digitales</title>
  <style>
    @media (prefers-color-scheme:dark) {
      :root {
        --temp :#072538;
        --gray-base: rgba(255,255,255,.8);
      }
      div.poncho-map {
        --slider-background: var(--black);
        --color-base: var(--gray-base);
        --color-primary:var(--cielo) ;
        --active-marker-alpha: 1;
      }
      div.poncho-map *.text-primary { color:var(--celeste-argentina) !important}
      *.text-arandano { color: var(--temp) !important;}
      summary { color:var(--gray-base); }
    }

    .charts_box { 
         background:rgba(0,0,0,.75); 
         color: rgba(255,255,255,.8); 
         padding:1em; 
         border-radius: 15px; 
         box-shadow: 0 0 6px rgba(0,0,0,.3);
         width: 100%;
    }
    .charts_box > h1 {
      color:var(--cielo);
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="http://localhost:5500/select2/dist/css/select2-poncho.css">
<!-- INCLUDE CSS -->
<link href="https://gis.argentina.gob.ar/js/leaflet/leaflet.css" rel="stylesheet"/>
<link href="https://gis.argentina.gob.ar/js/leaflet/MarkerCluster.Default.css" rel="stylesheet"/>
<link href="https://gis.argentina.gob.ar/js/leaflet/MarkerCluster.css" rel="stylesheet"/>
<!-- / INCLUDE CSS -->

<!-- INCLUDE SCRIPTS -->
<script src="https://gis.argentina.gob.ar/js/leaflet/leaflet.js"></script>
<script src="https://gis.argentina.gob.ar/js/leaflet/leaflet.markercluster.js"></script>

<!-- <script src="../../../dist/js/poncho.min.js"></script> -->
<script src="../../../src/js/poncho-map.js"></script>
<script src="../../../src/js/poncho-map-filter.js"></script>
<script src="../../../src/js/poncho-map-search.js"></script>
<script src="../../../src/js/gapi-sheet-data.js"></script>

<script src="./js/template-punto-digital.js"></script>
<!-- / INCLUDE SCRIPTS -->



<div class="container m-t-2">
  <div class="row">


    <div class="col-md-12 m-y-2">
      <h2 class="h4 text-primary">Buscá tu Punto Digital</h2>
      <div class="form-group m-b-0 webform-component">
        <select class="form-control poncho-map-search" data-scope="search-efectores" name="search">
          <option></option>
        </select>
      </div>
    </div>

    <div class="col-md-12">
<!-- poncho map -->

<div class="poncho-map" data-scope="poncho-map">
  <!-- leaflet -->
  <div
      class="leaflet-container leaflet-touch leaflet-fade-anim 
            leaflet-grab leaflet-touch-drag leaflet-touch-zoom"
      id="map"
      style="height:500px;width: 100%;"
      tabindex="0">
  </div>
  <!-- / leaflet -->
</div>
<!-- / poncho map -->
</div>
<div class="col-md-12  m-t-1">
  <div class="row">
    <div class="col-md-4">
      <section class="charts_box">
        <h1 class="h6">Totales</h1>  
        <div id="totals"></div>
      </section>

    </div>
    <div class="col-md-4">
      <section class="charts_box">
        <h1 class="h6">Totales por provincia</h1>  
        <div id="totals_provinces"></div>
      </section>
    </div>
  </div>
</div>
</div>
</div>
<!-- SCRIPTS -->
<script>
  var filter;
  // init
  (async() => {
    // fetch data
    const url = "./data/response.json";
    const sheet_data = await fetch_json(url); 
    const gdata = Object.keys(sheet_data.aPDs).map(e => sheet_data.aPDs[e]).flat();
    // map options
    const options = {
      "__template": template_punto_digital,
      "template": (self, ele) => {
          ele.address = [ele.calle, ele.localidad, ele.provincia].filter(e => e).join(", ");
          return self.defaultTemplate(self,ele);
      },
      "template_header": (self, row) => {
        return  `<p class="badge bg-cielo m-b-1">Punto digital</p>
            <h1 class="h4 text-primary m-t-0">${row.nombre}</h1>`;
      },
      "template_structure":{
          "title" : "nombre",
          "values": ["institucion", "address", "email", "telefono"]
      },
      "template_innerhtml":true,
      "headers" :{
        "institucion":"Tipo de institución",
        "address":"Dirección",
        "email":"Correo electrónico",
        "provincia":"Provincia",
        "localidad":"Localidad",
      },
      "scope":"poncho-map",
      "id": "id_pd",
      "latitud": "lat",
      "longitud": "long",
      "hash": true,
      "slider": false,
      "scroll": true,
      "marker":"arandano",
      "filters_visible":false,
      "reset_zoom":true,
      "filters" :[
        {
          "legend" : "Filtrar por estado",
          "type" : "radio",
          "fields" : [
              ["estado_funcionamiento", "Todos", ["1", "3"], "checked", "strict"],
              ["estado_funcionamiento", "Abiertos", ["1"], false, "strict"],
              ["estado_funcionamiento", "Próximamente", ["3"], false,"strict" ],
          ]
        },
        {
          "legend" : "Filtrar por región",
          "type" : "checkbox",
          "fields" : [
              ["provincia", "Buenos Aires y CABA", ["Buenos Aires", "Ciudad Autónoma de Buenos Aires"], "checked"],
              ["provincia", "Noreste Argentino", ["Chaco", "Corrientes", "Formosa", "Misiones"], "checked"],
              ["provincia", "Noroeste Argentino", ["Catamarca", "Jujuy", "La Rioja", "Salta", "Santiago del Estero", "Tucumán"], "checked"],
              ["provincia", "Región Centro", ["Córdoba", "Entre Ríos", "Santa Fe"], "checked"],
              ["provincia", "Región Cuyo", ["La Pampa", "Mendoza", "San Juan", "San Luis"], "checked"],
              ["provincia", "Región Patagonia", ["Chubut", "Neuquén", "Río Negro", "Santa Cruz", "Tierra del Fuego"], "checked"],
          ]
        },
      ],
      "marker_cluster_options": {
            "spiderfyOnMaxZoom": true,
            "showCoverageOnHover": false,
            "zoomToBoundsOnClick": true,
            "maxClusterRadius": 45,
        }
    };
    // render map
    filter = new PonchoMapFilter(gdata, options);
    filter.render();
    
    // Buscador
    const search_options = {
      "scope":"search-efectores",
      // "sort": true,
      // "sort_reverse":true,
      // "sort_key": "municipio_nombre",
      "text": "nombre",
      "id":"id_pd",
      "placeholder":"Buscá tu Punto Digital",
      "template": (self, entry) => {
        const tpl = `<p class="small">
            <i class="icono-arg-institucion"></i> 
            ${entry.institucion}
            </p>
            <dl class="p-b-0 m-y-0">
              <dt>${entry.nombre}</dt>
              <dd class="m-b-0">${entry.provincia}, ${entry.localidad}</dd>
            </dl>`;
        return tpl;
      },
      "search_fields": [
          "nombre",
          "institucion",
          "localidad",
          "provincia",
          "municipio_nombre"
      ]
    };
    search = new PonchoMapSearch(filter, search_options);
    search.render();

    // implementación para extender el módulo
    const provincias = [
          "Salta","Buenos Aires","Ciudad Autónoma de Buenos Aires",
          "San Luis","Entre Ríos","La Rioja","Santiago del Estero",
          "Chaco","San Juan","Catamarca","La Pampa","Mendoza",
          "Misiones","Formosa","Neuquén","Río Negro","Santa Fe",
          "Tucumán","Chubut","Tierra del Fuego","Corrientes",
          "Córdoba","Jujuy","Santa Cruz"
    ];
 
    totales_provincia = (obj) => {
      const chart = document.getElementById("totals_provinces");
      chart.innerHTML = "";
      for(const i of provincias){
        const total = obj.countOccurrences(obj.filtered_entries, [i], "provincia");
        if(total < 1)
            continue;
        const element = document.createElement("p");
        element.classList.add("m-b-0");
        element.textContent = [i, obj.countOccurrences(obj.filtered_entries, [i], "provincia")].join(": ");
        chart.appendChild(element);
      }
    }
    totales_provincia(filter);


    const total_charts = (obj) => {
        const chart = document.getElementById("totals");
        chart.innerHTML = "";
        for(const i of obj.totals()){
            const element = document.createElement("p");
            element.classList.add("m-b-0");
            element.textContent = [i[0], i[1]].join(": ");
            chart.appendChild(element);
          }
    };

    total_charts(filter);
    const change = document.querySelectorAll(".js-formulario input");
    change.forEach(k => k.addEventListener("change", () => {
        total_charts(filter);
        totales_provincia(filter);
      })
    )


  })();
</script>
<!-- / SCRIPTS -->
</body>
</html>



